# å•ä¾‹æ¨¡å¼  ğŸ€


<extoc></extoc>

## å®šä¹‰  ğŸ€

å•ä¾‹æ¨¡å¼ ( `Singleton Pattern` ) 

ç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ , è€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ ( `Ensure a class has only one instance, and provide a global point of access to it.` )

## åœºæ™¯  ğŸ€

åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ , è¦æ±‚ä¸€ä¸ªç±»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡ , å¦‚æœå‡ºç°å¤šä¸ªå¯¹è±¡å°±ä¼šå‡ºç° "ä¸è‰¯ååº”" , å¯ä»¥é‡‡ç”¨å•ä¾‹æ¨¡å¼ 

å¦‚ : 

- åœ¨æ•´ä¸ªé¡¹ç›®ä¸­éœ€è¦ä¸€ä¸ªå…±äº«è®¿é—®ç‚¹æˆ–å…±äº«æ•°æ®
- è¦ç”Ÿæˆå”¯ä¸€æ•°æ®
- åˆ›å»ºä¸€ä¸ªå¯¹è±¡éœ€è¦æ¶ˆè€—çš„èµ„æºè¿‡å¤š , å¦‚è¦è®¿é—® IO å’Œæ•°æ®åº“ç­‰èµ„æº
- éœ€è¦å®šä¹‰å¤§é‡çš„é™æ€å¸¸é‡å’Œé™æ€æ–¹æ³• (å¦‚å·¥å…·ç±») çš„ç¯å¢ƒ

æˆ‘ä»¬å¯èƒ½æœ€å¤šè§çš„å°±æ˜¯éœ€è¦å…±äº«æ•°æ® , æ¯”å¦‚åœ¨é¡¹ç›®ä¸­çš„é…ç½®æ•°æ® , åˆæ¯”å¦‚ Web æ¡†æ¶ä¸­çš„è·¯ç”±

## å®ä¾‹  ğŸ€

è¦å®ç°å•ä¾‹æ¨¡å¼ , å³ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ , å¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹

### Module  ğŸ€

Python ä¸­çš„ module å¤©ç”Ÿå°±æ˜¯å•ä¾‹ , è‡³äºä¸ºä»€ä¹ˆ , ä½ åº”è¯¥å»çœ‹çœ‹ [compiled-python-file](https://docs.python.org/3.6/tutorial/modules.html#compiled-python-files)

**singleton.py**

```python
class Singleton(object):
    pass

singleton = Singleton()
```

ä½¿ç”¨

```python
from singleton import singleton
```

### \_\_new__  ğŸ€

Python ä¸­çš„å¯¹è±¡å°†æœ‰ `__new__` æ¥å¼€è¾Ÿç©ºé—´åˆ›å»ºå®ä¾‹

```python
import threading

class Singleton(object):
    _threading_lock = threading.RLock()

    def __new__(cls, *args, **kwargs):
        if not hasattr(cls, "_instance"):
            with cls._threading_lock:
                if not hasattr(cls, "_instance"):
                    cls._instance = object.__new__(cls)
        return cls._instance
```

Python æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„ , æ‰€ä»¥ä¸ºäº†çº¿ç¨‹å®‰å…¨ , åŠ ä¸Šé”

### Metaclass  ğŸ€

ä½¿ç”¨å…ƒç±»æ¥å®ç°å•ä¾‹æ¨¡å¼ , å®é™…ä¸Šå°±æ˜¯æ§åˆ¶ `class()` çš„è¡Œä¸º , ä¹Ÿå°±æ˜¯ `__call__` é­”æœ¯æ–¹æ³•

å¦‚æœå¯¹äº `metaclass` ä¸æ‡‚ , ä½ å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ [ã€ŠPythonä¹‹è·¯ - å…ƒç±»ã€‹](<https://lyonyang.github.io/blogs/01-Python/09-In-Depth/09-Python%E4%B9%8B%E8%B7%AF%20-%20%E5%85%83%E7%B1%BB.html>)

```python
class SingletonMeta(type):
    
    _instances = {}

    def __call__(self, *args, **kwargs):
        if self not in self._instances:
            self._instances[self] = super(SingletonMeta, self).__call__(*args, **kwargs)
        return self._instances[self]

class Singleton(metaclass=SingletonMeta):
    pass

singleton = Singleton()
```

å…ƒç±»åˆ›å»ºç±»æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ , æ‰€ä»¥ä½ å¹¶ä¸éœ€è¦æ‹…å¿ƒæŠ¢å èµ„æºçš„é—®é¢˜

### ç±»è£…é¥°å™¨  ğŸ€

```python
def singleton(cls):
    _instance = {}

    def _singleton(*args, **kargs):
        if cls not in _instance:
            _instance[cls] = cls(*args, **kargs)
        return _instance[cls]

    return _singleton

@singleton
class Singleton:
    pass
```

ä½¿ç”¨ç±»è£…é¥°å™¨ , å®é™…ä¸Šå°±æ˜¯æŠŠç±»è½¬æ¢æˆä¸€ä¸ªå‡½æ•°å¯¹è±¡ , å› æ­¤è·Ÿå®ä¾‹çš„åˆ›å»ºå…³ç³»ä¸å¤§ , å› ä¸ºä»å§‹è‡³ç»ˆä¹Ÿå°±å®ä¾‹åŒ–äº†ä¸€æ¬¡ , è€Œä¸”å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„

### ç±»æ–¹æ³•  ğŸ€

é€šè¿‡æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–¹æ³•æ¥è·å–å¯¹è±¡ , è€Œä¸é€šè¿‡å®ä¾‹åŒ–çš„é€”å¾„

```python
class Singleton(object):

    @classmethod
    def instance(cls, *args, **kwargs):
        if not hasattr(cls, "_instance"):
            cls._instance = cls(*args, **kwargs)
        return cls._instance

singleton = Singleton.instance()
```

è™½ç„¶è¿™ç§æ–¹å¼ä¹Ÿèƒ½å®ç°å•ä¾‹æ¨¡å¼ , ä½†æ˜¯å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ , å°±ç®—åœ¨æ–¹æ³•é‡ŒåŠ äº†é” , ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ , è¿™é‡Œå¯èƒ½è·Ÿ Python çš„ç±»çš„åŠ è½½æœºåˆ¶æœ‰å…³ , ä¸æ·±ç©¶äº†

**æ³¨æ„ : åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ , åƒä¸‡è¦æŠŠ Python çš„åƒåœ¾å›æ”¶è¿™ä¸€é—®é¢˜éš”ç¦» , ä¹Ÿå°±æ˜¯è¯´å®ä¾‹ä¸è¦ä¸€å®ä¾‹åŒ–ä¹‹åå°±ä¸¢å¼ƒ , å¦åˆ™å¯èƒ½ä¼šå‡ºç°æ— æ•ˆçš„ç»“æœ**

