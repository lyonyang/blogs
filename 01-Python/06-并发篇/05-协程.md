#  Attack on Python - åç¨‹ ğŸ






<extoc></extoc>

## ä»‹ç»
[åç¨‹ (`Coroutine`)](https://zh.wikipedia.org/wiki/%E5%8D%8F%E7%A8%8B) , å°±æ˜¯ä¸€ç»„å¯ä»¥åè°ƒå·¥ä½œ [(åä½œå¼)](https://zh.wikipedia.org/wiki/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%A4%9A%E4%BB%BB%E5%8A%A1) çš„å­ç¨‹åº `(å‡½æ•°)` 

åç¨‹çš„æœ¬è´¨å°±æ˜¯ä¸€ç»„å‡½æ•° , ä¸€ç»„ååŒå·¥ä½œçš„å‡½æ•°

### çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«

ç›¸å¯¹äºçº¿ç¨‹è€Œè¨€ , çº¿ç¨‹æ˜¯æŠ¢å å¼çš„ , å®ƒçš„è°ƒåº¦æ–¹æ¡ˆæ˜¯ç”±æ“ä½œç³»ç»Ÿæ§åˆ¶çš„ , è€Œåç¨‹æ˜¯åä½œå¼æˆ–è€…è¯´éæŠ¢å å¼çš„ , ç”±ç¨‹åºè‡ªå·±ä¸»åŠ¨è®©å‡ºå¤„ç†å™¨ , æ‰€ä»¥åç¨‹ä¼šæ›´åŠ çš„çµæ´» ; å¹¶ä¸”çº¿ç¨‹æ˜¯æ˜‚è´µçš„ , çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æˆæœ¬è¦é«˜äºåç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ , è€Œä¸”åç¨‹ä¸ `CPU` å’Œæ“ä½œç³»ç»Ÿé€šå¸¸æ²¡æœ‰å…³ç³» , æ‰€ä»¥æ²¡æœ‰ç†è®ºä¸Šé™ , ä¹Ÿå°±æ˜¯è¯´ , åç¨‹è¦æ¯”çº¿ç¨‹è½»å¾—å¤š , è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåç¨‹åˆè¢«å«åš "å¾®çº¿ç¨‹"

"å¾®çº¿ç¨‹" åªæ˜¯ç”¨æ¥è¯´æ˜åç¨‹æ¯”çº¿ç¨‹è¦è½»é‡çº§ , ä½†æ˜¯åç¨‹å’Œçº¿ç¨‹å®Œå…¨æ˜¯ä¸¤ä¸ªæ¦‚å¿µ , è¯´ç™½äº†åç¨‹åªæ˜¯ä¸€ç»„å‡½æ•° , è€Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„å†…æ ¸å¯¹è±¡

åœ¨å†å²ä¸Šæ˜¯å…ˆæœ‰çš„åç¨‹ , åæœ‰çš„çº¿ç¨‹ , åç¨‹å‡ºç°çš„ç›®çš„æ˜¯ä¸ºäº†å®ç°å¹¶å‘ , è€Œçº¿ç¨‹åˆ™æ˜¯ä¸ºäº†å¹¶è¡Œ , ä¹Ÿå°±æ˜¯çº¿ç¨‹å¯ä»¥åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ (å½“ç„¶åœ¨ `Python` ä¸­ç”±äº `GIL` é”çº¿ç¨‹åŒæ ·æ— æ³•åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿) , è€Œåç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ , å¹¶ä¸”éæŠ¢å å¼è°ƒåº¦çš„å…¬å¹³æ€§æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ , æ‰€ä»¥ç›¸å¯¹è€Œè¨€åç¨‹éƒ½æ²¡å‚ä¸å¤šæ ¸ `CPU` å¹¶è¡Œå¤„ç† , è€Œçº¿ç¨‹å¯ä»¥åˆ©ç”¨å¤šæ ¸è¾¾åˆ°çœŸæ­£çš„å¹¶è¡Œè®¡ç®— , è¿™ä¸¤è€…çš„å·®è·å°±ä¸è¨€è€Œå–»äº† , è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåæ¥çº¿ç¨‹æ¯”åç¨‹è¦æ›´åŠ å¹¿æ³› ; è€Œåˆ°äº†ç°ä»£ , åç¨‹æ›´å¤šçš„æ˜¯ç”¨æ¥åšæˆä¸€ç»„æ‰§è¡Œé˜Ÿåˆ— , æ¯”å¦‚è¿­ä»£å™¨ , äº‹ä»¶å¾ªç¯ç­‰ç­‰

é‚£ä¸ºä»€ä¹ˆåç¨‹ç°åœ¨è¢«ç½‘ç»œä¸Šç¥åŒ–äº†å‘¢ ? æ¥ç€å¾€ä¸‹çœ‹

è¦å®ç°åç¨‹ , éœ€è¦å®ç°ä¸­æ–­ , æ¢å¤ , åˆ‡æ¢ä¸Šä¸‹æ–‡è¿™ä¸‰é¡¹åŠŸèƒ½ , åœ¨å®ç°ä¹‹å‰ , æˆ‘ä»¬å…ˆè¯´è¯´ç”Ÿæˆå™¨

## ç”Ÿæˆå™¨

ç”Ÿæˆå™¨æ˜¯ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ªå€¼çš„ç‰¹æ®Šç±»å‹å‡½æ•° , å®ƒå¯ä»¥è¿›è¡Œæƒ°æ€§æ±‚å€¼ ,  å› ä¸ºç”Ÿæˆå™¨æ¯æ¬¡è°ƒç”¨éƒ½åªç”Ÿæˆä¸€ä¸ªå€¼ , æ‰€ä»¥ä»–ä¸éœ€è¦æå‰å°†æ•°æ®åŠ è½½åˆ°å†…å­˜

åœ¨ `Python` ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ `yield` æ¥å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨ , `yield` è¯­å¥ä¼šæŠŠä½ éœ€è¦çš„å€¼è¿”å›ç»™è°ƒç”¨ç”Ÿæˆå™¨çš„åœ°æ–¹  , åé€€å‡ºå‡½æ•°  ä¸‹ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°çš„æ—¶å€™åˆä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œ , è€Œç”Ÿæˆå™¨å†…çš„æ‰€æœ‰å˜é‡å‚æ•°éƒ½ä¼šè¢«ä¿å­˜ä¸‹æ¥ä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨ , è¿™å°±æ˜¯ç”Ÿæˆå™¨å®ç°çš„åŸç†

### ç”Ÿæˆå™¨å’Œåç¨‹çš„å…³ç³»

ç”Ÿæˆå™¨å’Œåç¨‹çš„åŒºåˆ«å°±æ˜¯å®ƒä»¬éƒ½å¯ä»¥æŒ‚èµ·è‡ªèº«çš„æ‰§è¡Œ , æˆ–è€…è¯´æ‹¥æœ‰ä¸­æ–­èƒ½åŠ› , ä½†æ˜¯åç¨‹é™¤äº†ä¸­æ–­èƒ½åŠ› , è¿˜æ‹¥æœ‰æ§åˆ¶èƒ½åŠ› , åç¨‹å¯ä»¥æ§åˆ¶åœ¨å®ƒè®©ä½ä¹‹åå“ªä¸ªåç¨‹ç«‹å³ç»­å®ƒæ¥æ‰§è¡Œ , è€Œç”Ÿæˆå™¨ä¸èƒ½ , ç”Ÿæˆå™¨åªèƒ½æŠŠæ§åˆ¶æƒè½¬äº¤ç»™è°ƒç”¨ç”Ÿæˆå™¨çš„è°ƒç”¨è€… , æ‰€ä»¥ç”Ÿæˆå™¨ , ä¹Ÿå«åš "åŠåç¨‹" , æ˜¯åç¨‹çš„å­é›†

## å®ç°åç¨‹

åœ¨ `Python` çš„æ—©æœŸç‰ˆæœ¬é‡Œ , æˆ‘ä»¬å¯ä»¥é€šè¿‡ `yield` ä»¥åŠ `send` æ–¹æ³•æ¥å®ç°åç¨‹

```python
import time
from queue import Queue

q = Queue()

def produce(consumer):
    count = 0
    while True:
        while not q.qsize():
            count += 1
            q.put(count)
        time.sleep(1)
        print('[PRODUCER] Producing %s...' % count)
        # æ¢å¤
        consumer.send(count)

def consumer():
    while True:
        while q.qsize():
            count = q.get()
            time.sleep(1)
            print('[CONSUMER] Consuming %s...' % count)
        # ä¸­æ–­
        yield

consumer = consumer()
# åˆå§‹åŒ–ç”Ÿæˆå™¨
next(consumer)
produce(consumer)
```

ä¸€ä¸ªåç¨‹ä½œä¸ºç”Ÿäº§è€… , ä¸€ä¸ªåç¨‹ä½œä¸ºæ¶ˆè´¹è€… , è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„å¤šä»»åŠ¡ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ , ç”Ÿäº§è€…æ¶ˆè´¹è€…ååŒå·¥ä½œè‡ªåŠ¨åˆ‡æ¢ ,  `yield` æ¥ä¸­æ–­æ‰§è¡Œ ,  `send` æ¥æ¢å¤æ‰§è¡Œ , è€Œä»£ç é€»è¾‘æ§åˆ¶äº†ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ , è¿™ä¸ªä¾‹å­åªæ˜¯ä¸ºäº†è¯æ˜åç¨‹çš„å®ç”¨æ€§

ä½ å¯èƒ½ä¼šå‘ç° , æŠŠä¸Šé¢çš„ä»£ç æŒ‰ç…§ `yield` æ‹†åˆ†æˆå‡ ä¸ªå‡½æ•°åŠŸèƒ½ä¸Šæ˜¯ä¸€æ ·çš„ , æˆ‘ä»¬æŠŠæ‹†åˆ†çš„å‡½æ•°å«åš**å­ä¾‹ç¨‹** ,  å®é™…ä¸Š , å­ä¾‹ç¨‹å¯ä»¥çœ‹åšæ˜¯ç‰¹å®šçŠ¶æ€çš„åç¨‹ , ä»»ä½•çš„å­ä¾‹ç¨‹éƒ½å¯ä»¥è½¬å†™æˆä¸ä½¿ç”¨ `yield` çš„åç¨‹ 

### å­ä¾‹ç¨‹å’Œåç¨‹çš„åŒºåˆ«

ç›¸å¯¹äºå­ä¾‹ç¨‹è€Œè¨€ , åç¨‹æ›´åŠ çµæ´» , åç¨‹æ›´åŠ é€‚åˆç”¨æ¥å®ç°å½¼æ­¤æ¯”è¾ƒç†Ÿæ‚‰çš„ç¨‹åºç»„ä»¶ , æˆ–è€…è¯´è€¦åˆåº¦é«˜ä¸€ç‚¹çš„ç»„ä»¶ , æ¯”å¦‚ : [åä½œå¼å¤šä»»åŠ¡](https://zh.wikipedia.org/wiki/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%A4%9A%E4%BB%BB%E5%8A%A1)ã€[å¼‚å¸¸å¤„ç†](https://zh.wikipedia.org/wiki/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86)ã€[äº‹ä»¶å¾ªç¯](https://zh.wikipedia.org/wiki/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF)ã€[è¿­ä»£å™¨](https://zh.wikipedia.org/wiki/%E8%BF%AD%E4%BB%A3%E5%99%A8)ã€[æ— é™åˆ—è¡¨](https://zh.wikipedia.org/wiki/%E6%83%B0%E6%80%A7%E6%B1%82%E5%80%BC)å’Œ[ç®¡é“](https://zh.wikipedia.org/wiki/%E7%AE%A1%E9%81%93_(%E8%BD%AF%E4%BB%B6))

åç¨‹çš„åˆ‡æ¢æ¦‚å¿µæ˜¯ "è®©æ­¥" , è€Œå­ä¾‹ç¨‹çš„åˆ‡æ¢æ¦‚å¿µæ˜¯ "å‡ºäº§" , ä¸€ä¸ªä¸»åŠ¨ , ä¸€ä¸ªè¢«åŠ¨ , ä»¥ä¸‹æ‘˜è‡ª [Wiki](https://zh.wikipedia.org/wiki/%E5%8D%8F%E7%A8%8B) : 

- å­ä¾‹ç¨‹å¯ä»¥è°ƒç”¨å…¶ä»–å­ä¾‹ç¨‹ , è°ƒç”¨è€…ç­‰å¾…è¢«è°ƒç”¨è€…ç»“æŸåç»§ç»­æ‰§è¡Œ , æ•…è€Œå­ä¾‹ç¨‹çš„ç”Ÿå‘½æœŸéµå¾ªåè¿›å…ˆå‡º , å³æœ€åä¸€ä¸ªè¢«è°ƒç”¨çš„å­ä¾‹ç¨‹æœ€å…ˆç»“æŸè¿”å› , åç¨‹çš„ç”Ÿå‘½æœŸå®Œå…¨ç”±å¯¹å®ƒä»¬çš„ä½¿ç”¨éœ€è¦æ¥å†³å®š
- å­ä¾‹ç¨‹çš„èµ·å§‹å¤„æ˜¯æƒŸä¸€çš„å…¥å£ç‚¹ , æ¯å½“å­ä¾‹ç¨‹è¢«è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œéƒ½ä»è¢«è°ƒç”¨å­ä¾‹ç¨‹çš„èµ·å§‹å¤„å¼€å§‹ , åç¨‹å¯ä»¥æœ‰å¤šä¸ªå…¥å£ç‚¹ , åç¨‹çš„èµ·å§‹å¤„æ˜¯ç¬¬ä¸€ä¸ªå…¥å£ç‚¹ , æ¯ä¸ª `yield` è¿”å›å‡ºå£ç‚¹éƒ½æ˜¯å†æ¬¡è¢«è°ƒç”¨æ‰§è¡Œæ—¶çš„å…¥å£ç‚¹
- å­ä¾‹ç¨‹åªåœ¨ç»“æŸæ—¶ä¸€æ¬¡æ€§çš„è¿”å›å…¨éƒ¨ç»“æœå€¼ , åç¨‹å¯ä»¥åœ¨ `yield` æ—¶ä¸è°ƒç”¨å…¶ä»–åç¨‹ , è€Œæ˜¯æ¯æ¬¡è¿”å›ä¸€éƒ¨åˆ†çš„ç»“æœå€¼ , è¿™ç§åç¨‹å¸¸ç§°ä¸º[ç”Ÿæˆå™¨](https://zh.wikipedia.org/wiki/%E7%94%9F%E6%88%90%E5%99%A8_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BC%96%E7%A8%8B))æˆ–[è¿­ä»£å™¨](https://zh.wikipedia.org/wiki/%E8%BF%AD%E4%BB%A3%E5%99%A8)

æ‰€ä»¥åˆ°è¿™é‡Œ , åç¨‹çš„åº”ç”¨å¹¶æ²¡æœ‰çº¿ç¨‹é‚£ä¹ˆå¹¿æ³› , å¯èƒ½ä¹Ÿå¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆå¼ºå¤§ , è€Œä¸”åç¨‹æ˜¯åœ¨å•çº¿ç¨‹ä¸‹çš„ , åªè¦ä¸€å¤„é˜»å¡é‚£ä¹ˆæ•´ä¸ªåç¨‹å…¨éƒ¨éƒ½å¾—é˜»å¡ , å¹¶ä¸” `IO` æ˜¯ç³»ç»Ÿè°ƒç”¨ , è¿™ä¸ªä¸æ˜¯ç”¨æˆ·æ€èƒ½å¤„ç†çš„ , åç¨‹æ— æ³•ç»•å¼€

ä»¥ä¸Šå°±æ˜¯ "çº¯åç¨‹" äº† , æ‰€ä»¥ç»¼ä¸Š , åç¨‹çš„æ€§èƒ½æ˜¯æ¯”ä¸è¿‡çº¿ç¨‹çš„ , æ‰€ä»¥é‡åˆ° `IO` æ­£ç¡®çš„æ“ä½œåº”è¯¥æ˜¯ä½¿ç”¨å¤šçº¿ç¨‹ , ä¸ä¼šä¸€å µå…¨å µ , ä½†æ˜¯çº¿ç¨‹çš„è°ƒåº¦ç®—æ³•æ˜¯æ¯”è¾ƒåƒµç¡¬çš„ , æ—¶é—´ç‰‡çš„ç®—æ³•æ— æ³•å‡†ç¡®åœ°è¯†åˆ«çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç­‰å¾… `IO` , ä»è€Œé€ æˆäº†å¾ˆå¤šç©ºç­‰çš„ `CPU` èµ„æº , æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä½¿ç”¨åƒ `epoll` è¿™ç§å¼‚æ­¥å›è°ƒçš„æ–¹å¼ , è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¼‚æ­¥å›è°ƒçš„ä»£ç æ˜¯æ€ä¹ˆå†™çš„ : 

æœ‰3ä¸ª `IO` æ“ä½œæŒ‰é¡ºåºæ‰§è¡Œ , å…ˆæ‰§è¡Œ `select_data` , è€—æ—¶ `1` ç§’ , éšåæ‰§è¡Œ `update_data` , è€—æ—¶ `0.5` ç§’ , æœ€åå†æ‰§è¡Œ `delete_data` , è€—æ—¶ `0.3` ç§’

```python
import time

# 3ä¸ª IO æ“ä½œé¡ºåºæ‰§è¡Œ, é¡ºåºå¦‚ä¸‹: select_data, update_data, delete_data
# åŠŸèƒ½å‡½æ•°
def select_data(callback):
    def callback_for_select():
        time.sleep(1)
        result = 'select_data_result\n'
        return callback(result)
    # æ¨¡æ‹ŸIOå›è°ƒ
    return callback_for_select()


def update_data(select_result, callback):
    def callback_for_update():
        time.sleep(0.5)
        result = select_result + 'update_data_result\n'
        return callback(result)
    # æ¨¡æ‹ŸIOå›è°ƒ
    return callback_for_update()


def delete_data(update_result, callback):
    def callback_for_delete():
        time.sleep(0.3)
        result = update_result + 'delete_data_result'
        return callback(result)
    # æ¨¡æ‹ŸIOå›è°ƒ
    return callback_for_delete()

# æˆ‘ä»¬çš„è°ƒç”¨ä»£ç 
def select_callback(select_result):
    def update_callback(update_result):
        def delete_callback(delete_result):
            result = delete_result
            return result
        return delete_data(update_result, delete_callback)
    return update_data(select_result, update_callback)

result = select_data(select_callback)
print(result)

# è¿è¡Œç»“æœ
"""
select_data_result
update_data_result
delete_data_result
"""
```

ä¸éš¾å‘ç° , å¼‚æ­¥å›è°ƒå®é™…ä¸Šå°±æ˜¯ä¸€ç»„å­ä¾‹ç¨‹ååŒå·¥ä½œçš„è¿‡ç¨‹ , åªä¸è¿‡å®ƒçš„åˆ‡æ¢ç”±æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°æ¥æ§åˆ¶ , ä¸Šé¢è¿™æ®µä»£ç ä¸­ , é€šè¿‡é—­åŒ…æ¥ä¿å­˜ä¸Šä¸‹æ–‡ , ä¸ºäº†èƒ½è®©è¿™æ®µä»£ç è·‘èµ·æ¥ , æˆ‘ä»¬è¿™é‡Œå°±é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°æ¥æ¨¡æ‹Ÿ `IO` äº‹ä»¶çš„å›è°ƒ

ä¸Šé¢è¿™æ®µä»£ç  , å¦‚æœæˆ‘ä»¬ä½¿ç”¨åŒæ­¥çš„æ–¹å¼ , ä¼šæ˜¯è¿™æ ·çš„ : 

```python
# åŠŸèƒ½å‡½æ•°
def select_data():
    return 'select_data_result\n'

def update_data(select_data_result):
    return select_data_result + 'update_data_result\n'

def delete_data(update_data_result):
    return update_data_result + 'delete_data_result'

# æˆ‘ä»¬çš„è°ƒç”¨å‡½æ•°
select_result = select_data()
update_result = update_data(select_result)
delete_result = delete_data(update_result)
```

å¼‚æ­¥å’ŒåŒæ­¥åœ¨ä»£ç çš„å¯è¯»æ€§ä¸Šå·®åˆ«è¿˜æ˜¯ç›¸å½“çš„å¤§çš„ , å¼‚æ­¥å›è°ƒçš„ä»£ç å®ç°ç›¸å½“çš„å¤æ‚ , è€Œä¸”å¾ˆå®¹æ˜“é‡åˆ° `callback hell` , è€Œåœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»çŸ¥é“äº† , å­ä¾‹ç¨‹å¯ä»¥çœ‹ä½œæ˜¯ç‰¹å®šçš„åç¨‹ , ä»»ä½•å­ä¾‹ç¨‹éƒ½å¯ä»¥è½¬å†™ä¸ºä¸è°ƒç”¨ `yield` çš„åç¨‹ , å¦‚ä¸‹ : 

```python
def select_data():
    # æ¨¡æ‹ŸIOå›è°ƒ
    yield 'select_data_result\n'

def update_data(select_result):
    # æ¨¡æ‹ŸIOå›è°ƒ
    yield select_result + 'update_data_result\n'

def delete_data(update_result):
    # æ¨¡æ‹ŸIOå›è°ƒ
    yield update_result + 'delete_data_result'

def main():
    select_result = next(select_data())
    update_result = next(update_data(select_result))
    delete_result = next(delete_data(update_result))
    return delete_result

main()
```

è¿™é‡Œç®€å•çš„è§£é‡Šä¸€ä¸‹ , å› ä¸ºä»£ç æ— æ³•ä½“ç°å‡º `IO` çš„å¼‚æ­¥å›è°ƒ , æ‰€ä»¥åœ¨å¼‚æ­¥å›è°ƒçš„ç‰ˆæœ¬ä¸­é€šè¿‡ `callback_for_xx() ` è¿›è¡Œæ¨¡æ‹Ÿ , è€Œè¿™ä¸ª `yield` çš„ç‰ˆæœ¬ä¸­å°±æ˜¯é€šè¿‡ `yield` è¿›è¡Œæ¨¡æ‹Ÿ , å¦å¤–ä¸ç®¡æ˜¯æ“ä½œç³»ç»Ÿçš„åˆ‡æ¢(çº¿ç¨‹åˆ‡æ¢) , è¿˜æ˜¯æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„åˆ‡æ¢(åç¨‹åˆ‡æ¢) , éƒ½æ˜¯åˆ‡æ¢å‡ºå½“å‰çš„æ‰§è¡Œçº¿è®© `CPU` å»åšåˆ«çš„äº‹æƒ…

åˆ°è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¯¹æ¯” , æ˜æ˜¾åç¨‹çš„æ–¹å¼çš„å®ç°ä»£ç è¦æ¯”å¼‚æ­¥å›è°ƒæ–¹å¼çš„å®ç°ä»£ç å¯è¯»æ€§è¦é«˜å¾—å¤š , æ²¡æœ‰äº†å›è°ƒå™©æ¢¦

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åç¨‹çš„åŸå›  , å¯ä»¥æ›´å¥½çš„å’Œ `å¼‚æ­¥IO` ç»“åˆ , å¦‚æœç”¨ä¸€å¥è¯æ¦‚æ‹¬çš„è¯ : **è®©åŸæ¥è¦ä½¿ç”¨å¼‚æ­¥å›è°ƒæ–¹å¼å†™çš„éäººç±»ä»£ç  ,å¯ä»¥ç”¨çœ‹ä¼¼åŒæ­¥çš„æ–¹å¼å†™å‡ºæ¥**

è¿˜æœ‰ä¸€ç‚¹è¦è¯´æ˜çš„æ˜¯ , ç°åœ¨ç½‘ç»œä¸Šçš„ "åç¨‹" å…¶å®ä¸åªæ˜¯ "åç¨‹" , ä½ åœ¨ä¸Šé¢å¯ä»¥çœ‹åˆ°æˆ‘æœ‰å†™è¿‡ "çº¯åç¨‹" ; ç½‘ç»œä¸Šçš„åç¨‹å®é™…ä¸Šæ˜¯åç¨‹å’Œä¸€äº›ç»„ä»¶çš„ç»“åˆä½“ , å› ä¸ºåç¨‹æœ¬è´¨å°±æ˜¯ä¸€ç»„ååŒå·¥ä½œçš„ç¨‹åº , ä¸¾ä¸ªå…¸å‹ä¾‹å­ , `IO` é˜»å¡å°±ä¸æ˜¯åç¨‹èƒ½å¤„ç†çš„ , è€Œæ˜¯åç¨‹ + `epoll` çš„ç»“æœ , è€Œä¸”æœ‰çš„åç¨‹åº“è¿˜èåˆäº†å¤šçº¿ç¨‹æ¥å®ç°

## ä½¿ç”¨åç¨‹

åˆ°è¿™é‡Œ , åç¨‹çš„æ¦‚å¿µå·²ç»è®²å®Œäº† , é‚£ä¹ˆåç¨‹è¦æ€ä¹ˆå»ä½¿ç”¨å‘¢ ? 

åœ¨ `Python 3.4` å¼•å…¥äº† `asyncio` å¯¹å¼‚æ­¥ IO çš„æ”¯æŒ , è€Œåœ¨ `Python 3.5` å¼•å…¥äº† `async/await` ä¸¤ä¸ªå…³é”®å­—æä¾›äº†å¯¹æ— æ ˆåç¨‹(è§åæ–‡)çš„æ”¯æŒ 

åç¨‹çš„ä½¿ç”¨æœ‰ä¸ªå¾ˆå¤§çš„é—®é¢˜ , é‚£å°±æ˜¯æˆ‘ä»¬è¦å¦‚ä½•å»æ§åˆ¶è°ƒåº¦ , æœ‰ä¸€ä¸ªå¥½çš„æƒ³æ³•å°±æ˜¯æˆ‘ä»¬å¯ä»¥å¼„ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ— , ç„¶åå†è·‘ä¸€ä¸ªæ­»å¾ªç¯ , åˆ‡æ¢å°±æŠŠå½“å‰ä»»åŠ¡è¿½åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ , å†ä»å¤´éƒ¨å–ä¸€ä¸ªä»»åŠ¡ , ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ , å½“ç„¶å®ƒè¿˜è¦ä½ åº”è¯¥å…·å¤‡é‡åˆ°æ—¶é’Ÿé˜»å¡ , `IO` åˆ‡æ¢çš„åŠŸèƒ½ , å®ƒå°±æ˜¯äº‹ä»¶å¾ªç¯

æˆ‘ä»¬å…ˆçœ‹çœ‹å·²æœ‰çš„ `asyncio` æ€ä¹ˆå»ç¼–å†™å¼‚æ­¥ä»£ç  : 

```python
import asyncio

# åŠŸèƒ½å‡½æ•°
async def select_data():
    await asyncio.sleep(1)
    return 'select_data_result\n'

async def update_data(select_data_result):
    await asyncio.sleep(0.5)
    return select_data_result + 'update_data_result\n'

async def delete_data(update_data_result):
    await asyncio.sleep(0.3)
    return update_data_result + 'delete_data_result'

# è°ƒç”¨å‡½æ•°
async def main():
    select_result = await select_data()
    update_result = await update_data(select_result)
    delete_result = await delete_data(update_result)
    return delete_result

print(asyncio.get_event_loop().run_until_complete(main()))
```

`async` ç”¨æ¥å®šä¹‰ä¸€ä¸ªåç¨‹ , `await` åˆ™æ˜¯ç”¨æ¥åˆ‡æ¢ä¸Šä¸‹æ–‡ , æœ€ååˆ©ç”¨ `asyncio.get_event_loop` è·å–äº‹ä»¶å¾ªç¯æ¥å®Œæˆæˆ‘ä»¬çš„ä»»åŠ¡

## äº‹ä»¶å¾ªç¯



## æœ‰æ ˆåç¨‹ä¸æ— æ ˆåç¨‹

