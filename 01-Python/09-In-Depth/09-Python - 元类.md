# å…ƒç±»  ğŸ€

## å®šä¹‰  ğŸ€

[å…ƒç±»](https://zh.wikipedia.org/wiki/%E5%85%83%E7%B1%BB) ( metaclass ) , æ˜¯ä¸€ç§å®ä¾‹æ˜¯ç±»çš„ç±» 

æ™®é€šçš„ç±»å®šä¹‰çš„æ˜¯ç‰¹å®šå¯¹è±¡çš„è¡Œä¸º , å…ƒç±»å®šä¹‰çš„åˆ™æ˜¯ç‰¹å®šçš„ç±»åŠå…¶å¯¹è±¡çš„è¡Œä¸º , ä¸æ˜¯æ‰€æœ‰é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒå…ƒç±»

## type  ğŸ€

å…ƒç±»åœ¨ Wiki ä¸­çš„è§£é‡Šå·²ç»è¯´çš„å¾ˆæ˜ç¡®äº† , å®ƒæ˜¯ä¸€ç§å®ä¾‹æ˜¯ç±»çš„ç±» , è¿™ä¹Ÿå°±æ„å‘³ç€å…ƒç±»å¯ä»¥åˆ›é€ ç±»

è¿™ä¹ˆè¯´ä½ å¯èƒ½ä¼šä¸å¤ªæ¸…æ™° , æˆ‘ä»¬ä»é—®é¢˜å‡ºå‘ , åœ¨ Python ä¸­æ˜¯è°åˆ›å»ºäº†ç±» , ä¹Ÿå°±æ˜¯è¯´ Python ä¸­çš„å…ƒç±»æ˜¯è°?

å¦‚æœä½ çœ‹è¿‡ Python è¿™ä¸€éƒ¨åˆ†çš„æºç  , é‚£ä¹ˆæƒ³å¿…ä½ å¯¹è¿™ä¸ªé—®é¢˜è‚¯å®šäº†ç„¶äºå¿ƒ , æ²¡é”™å°±æ˜¯ `type` ç±»

```python
>>> object.__class__
<class 'type'>
```

è‡³äº `type` ç±»ä¸ºä»€ä¹ˆæ˜¯å…ƒç±» , ä½ å¯ä»¥ä»æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ä¸­è·å¾—ç­”æ¡ˆ [ã€Šå¯¹è±¡çš„åˆ›å»ºã€‹](<https://lyonyang.github.io/blogs/01-Python/09-In-Depth/02-Python%20-%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA.html>) 

çœ‹ä¸‹é¢çš„ä¾‹å­ : 

```python
>>> class Foo:
...     pass
...
>>> f = Foo()
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ , `Foo()` , ä¹Ÿå°±æ˜¯è°ƒç”¨ `Foo` çš„ `__call__` æ–¹æ³• , å®ƒä¼šåšä¸¤ä»¶äº‹æƒ… : 

1. è°ƒç”¨ `__new__` , åˆ›å»ºå¯¹è±¡
2. è°ƒç”¨ `__init__` , åˆå§‹åŒ–å¯¹è±¡

ä½†æ˜¯æ³¨æ„ , è¿™ä¸ª `__call__` æ˜¯ `object` ç±»çš„ , å› ä¸º Python 3 ä¸­æ‰€æœ‰çš„ç±»éƒ½é»˜è®¤ç»§æ‰¿äº† `object` , è‡³äº Python 2 æ²¡ä»€ä¹ˆå¥½è°ˆçš„ , ç›¸ä¿¡ä½ æŸ¥æŸ¥å°±èƒ½çŸ¥é“

æˆ‘ä»¬æœ¬å°±å¯ä»¥é€šè¿‡é‡è½½ `__new__` æ¥æ§åˆ¶å¯¹è±¡çš„åˆ›å»º , å¦‚ä¸‹ : 

```python
def new(cls):
    x = object.__new__(cls)
    x.attr = 100
    return x

Foo.__new__ = new

f = Foo()
print(f.attr)

g = Foo()
print(g.attr)
"""
æ‰§è¡Œç»“æœå¦‚ä¸‹: 
100
100
"""
```

ä½†æ˜¯ä¸åŒçš„æ˜¯ , ä½ å¯¹ `type` ä¸èƒ½è¿™ä¹ˆå¹² , Python ä¹Ÿä¸å…è®¸ä½ è¿™ä¹ˆå¹² , å¦‚æœå”¯ä¸€çš„å…ƒç±»éƒ½è¢«åŠ¨äº† , é‚£å°±ä¹±å¥—äº†

```python
def new(cls):
    x = type.__new__(cls)
    x.attr = 100
    return x

type.__new__ = new

"""
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: can't set attributes of built-in/extension type 'type'
"""
```

æ‰€ä»¥ä½ ä»è¿™é‡Œä¹Ÿå¯ä»¥çŸ¥é“ , `type` å’Œ `object` çš„åŒºåˆ«å°±åœ¨äº : 

- `type` çš„ `__new__` , è¿”å›äº†ä¸€ä¸ªç±»
- `object` çš„ `__new__` , è¿”å›äº†ä¸€ä¸ªå¯¹è±¡å®ä¾‹

å¦‚æœæˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ªå…ƒç±» , åªéœ€è¦å¦‚ä¸‹ : 

```python
class Meta(type):
    def __new__(cls, name, bases, dct):
        x = super().__new__(cls, name, bases, dct)
        x.attr = 100
        return x
```

å½“ç„¶ä½ ä¹Ÿçœ‹å‡ºæ¥äº† , è¿™åªæ˜¯ç»§æ‰¿ , è¦è®©å®ƒçœŸæ­£æˆä¸ºå…ƒç±» , ä½ è¿˜éœ€è¦å¦‚ä¸‹ :

```python
class Foo(metaclass=Meta):
    pass

print(Foo.attr)
```

æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ª `Foo` å’Œæ™®é€šçš„å¯¹è±¡æœ‰ä»€ä¹ˆä¸åŒ : 

```python
class Meta(type):
    def __new__(cls, name, bases, dct):
        x = super().__new__(cls, name, bases, dct)
        x.attr = 100
        return x
    
class Foo(metaclass=Meta):
    pass

class Bar(Foo):
    pass

print(type(Meta))
print(type(object))
print(type(Foo))
print(type(Bar))

"""
æ‰§è¡Œç»“æœå¦‚ä¸‹:
<class 'type'>
<class 'type'>
<class '__main__.Meta'>
<class '__main__.Meta'>
"""
```

å½“æŒ‡å®šäº† `metaclass` ä¹‹å , ç±»çš„åˆ›å»ºå°†ä¸å†ç”± `type` è´Ÿè´£ , è€Œæ˜¯ç”±å…ƒç±» `Meta` è´Ÿè´£ , ä¹Ÿå°±æ˜¯è¯´ `type` ç±»ä¸è¿™ç±»çš„ `Meta` ç±»éƒ½æ˜¯å…ƒç±» , å¤§å®¶æ˜¯åŒä¸€çº§

## å…ƒç±»çš„ä½œç”¨  ğŸ€

å…ƒç±»å¯ä»¥ç”¨æ¥æ”¹å˜ç±»çš„è¡Œä¸º , è¿™å’Œç±»å¹¶æ²¡æœ‰ä»€ä¹ˆå·®åˆ« , å› ä¸ºæˆ‘ä»¬å®šä¹‰ç±»ä¹Ÿå¯ä»¥æ”¹å˜å¯¹è±¡çš„è¡Œä¸º , æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­

```python
class Foo:
    pass

# è°ƒç”¨__call__
f = Foo()

# å¦‚æœæˆ‘ä»¬æƒ³æ”¹å˜ () ä¹Ÿå°±æ˜¯ __call__çš„è¡Œä¸ºè¦æ€ä¹ˆåš?
# å½“ç„¶ä¸å¯èƒ½æ˜¯åœ¨Fooç±»ä¸­é‡è½½ __call__ å› ä¸ºé‚£æ˜¯æ§åˆ¶ Foo å®ä¾‹åŒ–å‡ºæ¥çš„å¯¹è±¡çš„
# æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨å…ƒç±»æ¥æ§åˆ¶å®ƒ

# å•ä¾‹æ¨¡å¼ç›´æ¥ç”¨metaclassæ¥å®ç°, è€Œä¸”å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„
class SingletonMeta(type):
    _instances = {}

    def __call__(self, *args, **kwargs):
        if self not in self._instances:
            self._instances[self] = super(SingletonMeta, self).__call__(*args, **kwargs)
        return self._instances[self]


class Singleton(metaclass=SingletonMeta):
    pass

a = Singleton()
b = Singleton()
c = Singleton()
d = Singleton()
e = Singleton()
```

å¦‚æœä½ æƒ³è¦æ”¹å˜ç±»çš„è¡Œä¸º , é™¤äº† Python é»˜è®¤æä¾›çš„ä¸€ä¸ªé­”æœ¯æ–¹æ³• (`__new__`) , ä½ å¿…é¡»é€šè¿‡å…ƒç±»æ¥æ”¹å˜

**å› ä¸º `__new__` æ˜¯å”¯ä¸€ä¸€ä¸ªç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯ `self` è€Œæ˜¯ `cls` çš„é­”æœ¯æ–¹æ³•**

æ‰€ä»¥ä¸Šé¢è¿™ä¸ªä¾‹å­ , é™¤äº†ç”¨å…ƒç±» , ä½ ä¹Ÿå¯ä»¥é€šè¿‡è¦†ç›– `__new__` æ¥å®ç°  

å…ƒç±»å…¶å®å°±æ˜¯ä¸€ä¸ªç±»å·¥å‚ , è€Œç±»åˆ™æ˜¯å¯¹è±¡å·¥å‚ , ä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨å…ƒç±»åŒæ ·å¯ä»¥è¾¾åˆ°ç”Ÿäº§çš„ç›®çš„ , å› ä¸ºé€šå¸¸æˆ‘ä»¬ä¸ä¼šéœ€è¦å»æ”¹å˜ç±»çš„è¡Œä¸º , éœ€è¦æ”¹å˜çš„æ˜¯å¯¹è±¡çš„è¡Œä¸º

çœ‹ä¸‹é¢å‡ ä¸ªä¾‹å­

**ç»§æ‰¿**

```python
>>> class Base:
...     attr = 100
...

>>> class X(Base):
...     pass
...

>>> class Y(Base):
...     pass
...

>>> class Z(Base):
...     pass
...

>>> X.attr
100
>>> Y.attr
100
>>> Z.attr
100
```

**ç±»è£…é¥°å™¨**

```python
>>> def decorator(cls):
...     class NewClass(cls):
...         attr = 100
...     return NewClass
...
>>> @decorator
... class X:
...     pass
...
>>> @decorator
... class Y:
...     pass
...
>>> @decorator
... class Z:
...     pass
...

>>> X.attr
100
>>> Y.attr
100
>>> Z.attr
100
```

æ€»è€Œè¨€ä¹‹ , å…ƒç±»çš„ä½œç”¨å°±æ˜¯ç”¨æ¥åˆ›é€ ç±»çš„ , æˆ‘ä»¬é€šå¸¸æ›´å¤šçš„æ˜¯ä½¿ç”¨ç»§æ‰¿ (ä¹Ÿå°±æ˜¯åˆ©ç”¨æŠ½è±¡) çš„æ–¹å¼æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„

Python ä¹‹ç¦…ä¸­è¿™ä¹ˆè¯´åˆ° : å…ƒç±»æ˜¯æ·±å±‚æ¬¡çš„é­”æœ¯ä»£ç  , 99% çš„ç”¨æˆ·éƒ½ä¸éœ€è¦å…³å¿ƒå®ƒ , å¦‚æœä½ å¥½å¥‡ä½ æ˜¯å¦éœ€è¦ , é‚£ä½ å°±ä¸éœ€è¦ , çœŸæ­£éœ€å…ƒç±»çš„äºº , æ˜¯å¾ˆæ¸…æ¥šä»–ä»¬éœ€è¦çš„ , å¹¶ä¸” , ä¸éœ€è¦ä¸€ä¸ªç†ç”±æ¥è§£é‡Š

ç®€å•çš„è¯´ , å…ƒç±»ä¸é€‚åˆåœ¨ç”Ÿäº§çš„ä»£ç ä¸­ä½¿ç”¨ , å®ƒæ›´é€‚åˆç”¨æ¥è®¾è®¡ , æ¯”å¦‚ Django , SQLAlchemy ä¸­ , ä½ å°±èƒ½å‘ç°å®ƒçš„èº«å½± , æ€»è€Œè¨€ä¹‹ , **å…ƒç±»æ§åˆ¶ç±» , ç±»æ§åˆ¶å¯¹è±¡**

