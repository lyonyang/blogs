# MySQL - äº‹åŠ¡




<extoc></extoc>

## ä»‹ç»  ðŸ€

äº‹åŠ¡å°±æ˜¯æ»¡è¶³ `ACID` ç‰¹æ€§çš„ä¸€ç»„æ“ä½œ 

åœ¨ `MySQL` ä¸­ , å¯ä»¥ç”¨ `START TRANSACTION` æˆ– `BEGIN` å¼€å¯ä¸€ä¸ªäº‹åŠ¡ , ç„¶åŽä½¿ç”¨ `COMMIT` æäº¤äº‹åŠ¡å°†ä¿®æ”¹çš„æ•°æ®æŒä¹…ä¿ç•™ , æˆ–è€…ä½¿ç”¨ `ROLLBACK` æ’¤é”€æ‰€æœ‰çš„ä¿®æ”¹

åœ¨ `MySQL` ä¸­é»˜è®¤è‡ªåŠ¨æäº¤ (Autocommit) , å¦‚æžœéœ€è¦é€šè¿‡æ˜Žç¡®çš„ `COMMIT` å’Œ `ROLLBACK` æ¥æäº¤å’Œå›žæ»šäº‹åŠ¡ , é‚£ä¹ˆå°±éœ€è¦é€šè¿‡æ˜Žç¡®çš„äº‹åŠ¡æŽ§åˆ¶å‘½ä»¤æ¥å¼€å§‹äº‹åŠ¡ 


## ACID  ðŸ€

### åŽŸå­æ€§ (Atomicity)

ä¸€ä¸ªäº‹åŠ¡å¿…é¡»è¢«è§†ä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒ , æ•´ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸ , è¦ä¹ˆå…¨éƒ¨å¤±è´¥å›žæ»š , å¯¹äºŽä¸€ä¸ªäº‹åŠ¡æ¥è¯´ , ä¸å¯èƒ½åªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ“ä½œ

### ä¸€è‡´æ€§ (Consistency)

æ•°æ®åº“åœ¨äº‹åŠ¡æ‰§è¡Œå‰åŽéƒ½ä¿æŒä¸€è‡´æ€§çŠ¶æ€ , åœ¨ä¸€è‡´æ€§çŠ¶æ€ä¸‹ , æ‰€æœ‰äº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®çš„è¯»å–ç»“æžœéƒ½æ˜¯ç›¸åŒçš„

### éš”ç¦»æ€§ (Isolation)

ä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ , å¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„

### æŒä¹…æ€§ (Durability)

ä¸€æ—¦äº‹åŠ¡æäº¤ , åˆ™å…¶æ‰€åšçš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“ä¸­ , æ­¤æ—¶å³ä½¿ç³»ç»Ÿå´©æºƒ , ä¿®æ”¹çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±

## å¹¶å‘é—®é¢˜  ðŸ€

åœ¨æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ , äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ , éš”ç¦»æ€§ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ , ä½†æ˜¯åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ , å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ‰§è¡Œ , äº‹åŠ¡çš„éš”ç¦»æ€§å°±æ— æ³•å¾—åˆ°ä¿è¯

### ä¸¢å¤±ä¿®æ”¹

ä¸¢å¤±ä¿®æ”¹æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°æ“ä½œè¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°æ“ä½œè¦†ç›–

**ä¾‹å¦‚ :** `T1` å’Œ `T2` ä¸¤äº‹åŠ¡åŒæ—¶èŽ·å–äº†ä¸€ä¸ªæ•°æ® , `T1` å…ˆä¿®æ”¹å¹¶æäº¤ç”Ÿæ•ˆ , éšåŽ `T2` åˆä¿®æ”¹å¹¶æäº¤ , è¿™ä¸ªæ—¶å€™ `T1` çš„ä¿®æ”¹å°±ä¼šè¢« `T2` è¦†ç›–æŽ‰

### è¯»è„æ•°æ®

è¯»è„æ•°æ®æ˜¯æŒ‡åœ¨ä¸åŒçš„äº‹åŠ¡ä¸‹ , ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®

**ä¾‹å¦‚ :** `T1` å’Œ `T2` ä¸¤ä¸ªäº‹åŠ¡ , `T1` å…ˆä¿®æ”¹æŸä¸ªæ•°æ®å¹¶æäº¤ç”Ÿæ•ˆ , éšåŽ `T2` èŽ·å–è¯¥æ•°æ® , ä½†æ˜¯è¿™ä¸ªæ—¶å€™ `T1` ç”±äºŽæŸäº›åŽŸå› æŠŠåˆšæ‰çš„ä¿®æ”¹æ’¤é”€äº† , ä¹Ÿå°±æ˜¯å›žæ»šäº† , è¿™ä¸ªæ—¶å€™ `T2` èŽ·å–çš„æ•°æ®å°±æ˜¯è„æ•°æ®

### ä¸å¯é‡å¤è¯»

ä¸å¯é‡å¤è¯»æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€ä¸ªæ•°æ® , ç”±äºŽä¸­é€”è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº† , å¯¼è‡´è¯»å–çš„ç»“æžœä¸ä¸€è‡´

**ä¾‹å¦‚ :** `T1` å’Œ `T2` ä¸¤ä¸ªäº‹åŠ¡ , `T1` å…ˆè¯»å–äº†ä¸€ä¸ªæ•°æ® , è¿™æ—¶ `T2` å°†è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹ , ä¹‹åŽ `T1` åˆè¯»å–è¿™ä¸ªæ•°æ® , å‘çŽ°ä¸¤æ¬¡è¯»å–æ“ä½œèŽ·å–çš„ç»“æžœä¸ä¸€è‡´ , æ³¨æ„ `T1` çš„ä¸¤æ¬¡è¯»å–æ˜¯ä¸€ç»„æ“ä½œ

### å¹»å½±è¯»

å¹»å½±è¯»æœ¬è´¨ä¸Šä¹Ÿå±žäºŽä¸å¯é‡å¤è¯» , å®ƒä¹Ÿæ˜¯ä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–æ•°æ® , ä½†æ˜¯ç”±äºŽä¸­é€”è¢«å…¶ä»–äº‹åŠ¡æ–°å¢žæˆ–è€…åˆ é™¤äº† , å¯¼è‡´è¯»å–çš„æ¡æ•°ä¸ä¸€è‡´

**ä¾‹å¦‚ :** `T1` å’Œ `T2` ä¸¤ä¸ªäº‹åŠ¡ , `T1` è¯»å–æŸä¸ªèŒƒå›´çš„æ•°æ® , `T2` åœ¨è¿™ä¸ªèŒƒå›´å†…æ–°å¢žæˆ–è€…åˆ é™¤äº†æŸæ¡æ•°æ® , è¿™ä¸ªæ—¶å€™  `T1` å†æ¬¡è¯»å–è¿™ä¸ªèŒƒå›´çš„æ•°æ® , è¿™ä¸ªæ—¶å€™è¯»å–çš„ç»“æžœå’Œç¬¬ä¸€æ¬¡è¯»å–çš„ç»“æžœä¸ä¸€è‡´

äº§ç”Ÿå¹¶å‘ä¸ä¸€è‡´é—®é¢˜çš„ä¸»è¦åŽŸå› æ˜¯ç ´åäº†äº‹åŠ¡ä¹‹é—´çš„éš”ç¦»æ€§ , è¦è§£å†³è¿™ä¸ªé—®é¢˜å°±æ˜¯è¦é€šè¿‡å¹¶å‘æŽ§åˆ¶æ¥ä¿è¯éš”ç¦»æ€§ , ä½¿ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸å—å…¶ä»–äº‹åŠ¡çš„å¹²æ‰° , ä»Žè€Œé¿å…é€ æˆè¿‡æ•°æ®çš„ä¸ä¸€è‡´æ€§ , è€Œå®žçŽ°å¹¶å‘æŽ§åˆ¶çš„ä¸€ä¸ªéžå¸¸é‡è¦çš„æŠ€æœ¯å°±æ˜¯å°é”

## å°é”  ðŸ€

### å°é”ç²’åº¦

åœ¨ `MySQL` ä¸­ , ä¸åŒçš„å­˜å‚¨å¼•æ“Ž , æä¾›çš„å°é”ç²’åº¦æ˜¯ä¸ä¸€æ ·çš„ , å„ä¸ªå­˜å‚¨å¼•æ“Žå¯¹å°é”ç²’åº¦çš„æ”¯æŒå¦‚ä¸‹ : 

| å­˜å‚¨å¼•æ“Ž | MyISAM | InnoDB | MEMORY | MERGE  | NDB    |
| -------- | ------ | ------ | ------ | ------ | ------ |
| å°é”ç²’åº¦ | è¡¨çº§é” | è¡Œçº§é” | è¡¨çº§é” | è¡¨çº§é” | è¡Œçº§é” |

é™¤äº†è¡¨çº§é”å’Œè¡Œçº§é”ä¹‹å¤– , åœ¨æ—©æœŸ `MySQL 5.1` ä¹‹å‰ , è¿˜æœ‰ `BDB` å­˜å‚¨å¼•æ“Ž , æ”¯æŒé¡µé¢é” , è¿™ä¸‰ç§é”çš„ç‰¹æ€§å¦‚ä¸‹ : 

- è¡¨çº§é” : å¼€é”€å° , åŠ é”å¿« ; ä¸ä¼šå‡ºçŽ°æ­»é” ; é”å®šç²’åº¦å¤§ , å‘ç”Ÿé”å†²çªçš„æ¦‚çŽ‡æœ€é«˜ , å¹¶å‘åº¦æœ€ä½Ž
- è¡Œçº§é” : å¼€é”€å¤§ , åŠ é”æ…¢ ; ä¼šå‡ºçŽ°æ­»é” ; é”å®šç²’åº¦æœ€å° , å‘ç”Ÿé”å†²çªçš„æ¦‚çŽ‡æœ€ä½Ž , å¹¶å‘åº¦ä¹Ÿæœ€é«˜
- é¡µé¢é” : å¼€é”€å’ŒåŠ é”æ—¶é—´ä»‹äºŽè¡¨é”å’Œè¡Œé”ä¹‹é—´ ; ä¼šå‡ºçŽ°æ­»é” ; é”å®šç²’åº¦ä»‹äºŽè¡¨é”å’Œè¡Œé”ä¹‹é—´ , å¹¶å‘åº¦ä¸€èˆ¬

ä»Žä¸Šè¿°ç‰¹ç‚¹å¯è§ , å¾ˆéš¾ç¬¼ç»Ÿåœ°è¯´å“ªç§é”æ›´å¥½ , åœ¨é€‰æ‹©å°é”ç²’åº¦æ—¶ , éœ€è¦åœ¨å¼€é”€å’Œå¹¶å‘åº¦ä¹‹é—´åšä¸€ä¸ªæƒè¡¡

### å°é”ç±»åž‹

åŸºæœ¬å°é”ç±»åž‹æœ‰ä¸¤ç§ , å…±äº«é” (Shared) , ç®€å†™ä¸º S é” , åˆç§°è¯»é” ;  æŽ’ä»–é” (Exclusive) ä¹Ÿå¯ä»¥å«äº’æ–¥é” , ç®€å†™ä¸º X é” , åˆç§°å†™é”

**å…±äº«é” :** ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† S é” , å¯ä»¥å¯¹ A è¿›è¡Œè¯»å–æ“ä½œ , ä½†æ˜¯ä¸èƒ½è¿›è¡Œæ›´æ–°æ“ä½œ , åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡èƒ½å¯¹ A åŠ  S é” , ä½†æ˜¯ä¸èƒ½åŠ  X é”

**æŽ’ä»–é” :** ä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®å¯¹è±¡ A åŠ äº† X é” , å°±å¯ä»¥å¯¹ A è¿›è¡Œè¯»å–å’Œæ›´æ–°æ“ä½œ , åŠ é”æœŸé—´å…¶å®ƒäº‹åŠ¡ä¸èƒ½å¯¹ A åŠ ä»»ä½•é”

é™¤äº†å…±äº«é”å’ŒæŽ’ä»–é”ä¹‹å¤– , ä¸ºäº†å…è®¸è¡Œé”å’Œè¡¨é”å…±å­˜ , å®žçŽ°å¤šç²’åº¦é”æœºåˆ¶ , è¿˜æœ‰æ„å‘é” (Intention Locks)

æ„å‘å…±äº«é” (IS) : ä¸€ä¸ªäº‹åŠ¡åœ¨èŽ·å–æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ S é”ä¹‹å‰ , å¿…é¡» å…ˆèŽ·å¾—è¡¨çš„ IS é”æˆ–è€…æ›´å¼ºçš„é”

æ„å‘æŽ’ä»–é” (IX) : ä¸€ä¸ªäº‹åŠ¡åœ¨èŽ·å–æŸä¸ªæ•°æ®è¡Œå¯¹è±¡çš„ X é”ä¹‹å‰ , å¿…é¡»å…ˆèŽ·å¾—è¡¨çš„ IX é”

æ„å‘é”å…¼å®¹å…³ç³»å¦‚ä¸‹ : 

| é”   | X    | IX       | S        | IS       |
| ---- | ---- | -------- | -------- | -------- |
| X    | å†²çª | å†²çª     | å†²çª     | å†²çª     |
| IX   | å†²çª | **å…¼å®¹** | å†²çª     | **å…¼å®¹** |
| S    | å†²çª | å†²çª     | **å…¼å®¹** | **å…¼å®¹** |
| IS   | å†²çª | **å…¼å®¹** | **å…¼å®¹** | **å…¼å®¹** |

è§£é‡Šå¦‚ä¸‹ : 

1. ä»»æ„ IS/IX é”ä¹‹é—´éƒ½æ˜¯å…¼å®¹çš„ , å› ä¸ºå®ƒä»¬åªè¡¨ç¤ºæƒ³è¦å¯¹è¡¨åŠ é” , è€Œä¸æ˜¯çœŸæ­£åŠ é”
2. è¿™é‡Œçš„å…¼å®¹å…³ç³»é’ˆå¯¹çš„è¡¨çº§é” , è€Œè¡¨é”çš„ IX é”å’Œè¡Œçº§çš„ X é”å…¼å®¹ ,  ä¸¤ä¸ªäº‹åŠ¡å¯ä»¥å¯¹ä¸¤ä¸ªæ•°æ®è¡ŒåŠ  X é”

### å°é”åè®®

åœ¨è¿ç”¨é”å¯¹æ•°æ®å¯¹è±¡åŠ é”æ—¶ , è¿˜éœ€è¦çº¦å®šä¸€äº›è§„åˆ™ , ä¾‹å¦‚åº”ä½•æ—¶ç”³è¯·Xé”æˆ–Sé” , æŒé”æ—¶é—´ , ä½•æ—¶é‡Šæ”¾ç­‰ , è¿™å°±æ˜¯å°é”åè®® (Locking Protocol)

**ä¸€çº§å°é”åè®®**

äº‹åŠ¡ T åœ¨ä¿®æ”¹æ•°æ® A ä¹‹å‰å¿…é¡»å…ˆå¯¹å…¶åŠ  X é” , ç›´åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾

ä¸€çº§å°é”åè®®å¯é˜²æ­¢ä¸¢å¤±ä¿®æ”¹ , å› ä¸ºä¸èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹ , æ‰€ä»¥äº‹åŠ¡çš„ä¿®æ”¹ä¸ä¼šè¢«è¦†ç›–

**äºŒçº§å°é”åè®®**

åœ¨ä¸€çº§å°é”åè®®çš„åŸºç¡€ä¸Š , è¦æ±‚è¯»å–æ•°æ® A ä¹‹å‰å¿…é¡»å…ˆå¯¹å…¶åŠ  S é” , è¯»å®ŒåŽå³å¯é‡Šæ”¾ S é”

äºŒçº§å°é”åè®®é™¤äº†é˜²æ­¢ä¸¢å¤±ä¿®æ”¹ , è¿˜å¯ä»¥é˜²æ­¢è¯»è„æ•°æ® , å› ä¸ºæ ¹æ®ä¸€çº§å°é”åè®® , åœ¨ä¿®æ”¹æ•°æ®æ—¶ , ä¼šåŠ  X é” , è¿™æ ·å°±æ— æ³•å†åŠ  S é”äº† , ä¹Ÿå°±ä¸ä¼šå†æ¬¡è¯»å–æ•°æ®

**ä¸‰çº§å°é”åè®®**

åœ¨ä¸€çº§å°é”åè®®çš„åŸºç¡€ä¸Š , è¦æ±‚è¯»å–æ•°æ® A ä¹‹å‰å¿…é¡»å¯¹å…¶åŠ  S é” , ç›´åˆ°äº‹åŠ¡ç»“æŸæ‰èƒ½é‡Šæ”¾ S é”

ä¸‰çº§å°é”åè®®é™¤äº†é˜²æ­¢ä¸¢å¤±ä¿®æ”¹å’Œè¯»è„æ•°æ®ä¹‹å¤– , è¿˜è¿›ä¸€æ­¥é˜²æ­¢äº†ä¸å¯é‡å¤è¯»

**ä¸¤é˜¶æ®µé”å®šåè®®**

åŠ é”å’Œè§£é”åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µè¿›è¡Œ , åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹è¿½è¸ª , éšæ—¶éƒ½å¯ä»¥æ‰§è¡Œé”å®š , é”åªæœ‰åœ¨æ‰§è¡Œ `COMMIT` æˆ–è€… `ROLLBACK` çš„æ—¶å€™æ‰ä¼šé‡Šæ”¾ , å¹¶ä¸”æ‰€æœ‰çš„é”æ˜¯åœ¨åŒä¸€æ—¶åˆ»é‡Šæ”¾ , InnoDB é‡‡ç”¨çš„æ­£å¼è¿™ç§åè®®

**éšå¼å’Œæ˜¾å¼é”å®š**

`InnoDB` ä¼šæ ¹æ®éš”ç¦»çº§åˆ«åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åŠ é” (éšå¼) , åŒæ—¶ä¹Ÿæ”¯æŒé€šè¿‡ç‰¹å®šçš„è¯­å¥è¿›è¡Œæ˜¾å¼é”å®š 

```SQL
SELECT ... LOCK IN SHARE MODE;
SELECT .. FOR UPDATE;
```

## éš”ç¦»çº§åˆ«  ðŸ€

å¹¶å‘æŽ§åˆ¶å¯ä»¥é€šè¿‡å°é”æ¥å®žçŽ° , ä½†æ˜¯å°é”éœ€è¦ç”¨æˆ·è‡ªå·±æŽ§åˆ¶å¦‚ä½•åŠ é” , ä»¥åŠåŠ é”å’Œè§£é”çš„æ—¶æœº , ç›¸å½“å¤æ‚ , æ‰€ä»¥ç»å¤§å¤šæ•°æ•°æ®åº“ä»¥åŠå¼€å‘å·¥å…·éƒ½æä¾›äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ« , è®©ç”¨æˆ·ä»¥ä¸€ç§æ›´è½»æ¾çš„æ–¹å¼å¤„ç†å¹¶å‘ä¸€è‡´æ€§é—®é¢˜

### æœªæäº¤è¯» (READ UNCOMMITTED)

äº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ , ä¹Ÿå°±æ„å‘³ç€ä¼šå‡ºçŽ°è„è¯»çŽ°è±¡

è¿™ä¸ªçº§åˆ«ä¼šå¯¼è‡´å¾ˆå¤šé—®é¢˜ , ä»Žæ€§èƒ½ä¸Šæ¥è¯´ , `READ UNCOMMITTED` ä¸ä¼šæ¯”å…¶ä»–çš„çº§åˆ«å¥½å¤ªå¤š , ä½†å´ç¼ºä¹å…¶ä»–çº§åˆ«çš„å¾ˆå¤šå¥½å¤„ , é™¤éžçœŸçš„æœ‰éžå¸¸å¿…è¦çš„ç†ç”± , åœ¨å®žé™…åº”ç”¨ä¸­ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨

### æäº¤è¯» (READ COMMITTED)

ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ , æ¢å¥è¯è¯´ , ä¸€ä¸ªäº‹åŠ¡ä»Žå¼€å§‹ç›´åˆ°æäº¤ä¹‹å‰ , æ‰€åšçš„ä»»ä½•ä¿®æ”¹å¯¹å…¶ä»–äº‹åŠ¡éƒ½æ˜¯ä¸å¯è§çš„

å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«éƒ½æ˜¯ `READ COMMITTED` 

### å¯é‡å¤è¯» (REPEATABLE READ)

ä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®çš„ç»“æžœæ˜¯ä¸€è‡´çš„

ä½†æ˜¯ç†è®ºä¸Š , å¯é‡å¤è¯»éš”ç¦»çº§åˆ«è¿˜æ˜¯æ— æ³•è§£å†³å¹»è¯»é—®é¢˜ , å¯é‡å¤è¯»æ˜¯ `MySQL` çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«

### å¯ä¸²è¡ŒåŒ– (SERIALIZABLE)

å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ , è¿™æ ·å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸ä¼šå‡ºçŽ°å¹¶å‘ä¸€è‡´æ€§é—®é¢˜

è¯¥éš”ç¦»çº§åˆ«éœ€è¦åŠ é”å®žçŽ° , å› ä¸ºè¦ä½¿ç”¨åŠ é”æœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œ , ä¹Ÿå°±æ˜¯ä¿è¯äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ

`SERIALIZABLE` ä¼šåœ¨è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®ä¸Šéƒ½åŠ é” , æ‰€ä»¥å¯èƒ½å¯¼è‡´å¤§é‡çš„è¶…æ—¶å’Œé”äº‰ç”¨çš„é—®é¢˜ , å®žé™…åº”ç”¨ä¸­å¾ˆå°‘ç”¨åˆ°è¿™ä¸ªéš”ç¦»çº§åˆ« , åªæœ‰åœ¨éžå¸¸éœ€è¦ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§è€Œä¸”å¯ä»¥æŽ¥å—æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ , æ‰è€ƒè™‘é‡‡ç”¨è¯¥çº§åˆ«

è¿™å››ä¸ªéš”ç¦»çº§åˆ«å¯¹æ¯”å¦‚ä¸‹ : 

| éš”ç¦»çº§åˆ« | è¯»æ•°æ®ä¸€è‡´æ€§                              | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»å½±è¯» |
| -------- | ----------------------------------------- | ---- | ---------- | ------ |
| æœªæäº¤è¯» | æœ€ä½Žçº§åˆ« , åªèƒ½ä¿è¯ä¸è¯»å–ç‰©ç†ä¸ŠæŸåçš„æ•°æ® | æ˜¯   | æ˜¯         | æ˜¯     |
| å·²æäº¤è¯» | è¯­å¥çº§                                    | å¦   | æ˜¯         | æ˜¯     |
| å¯é‡å¤è¯» | äº‹åŠ¡çº§                                    | å¦   | å¦         | æ˜¯     |
| å¯åºåˆ—åŒ– | æœ€é«˜çº§åˆ« , äº‹åŠ¡çº§                         | å¦   | å¦         | å¦     |


## MySQLä¸­ä½¿ç”¨äº‹åŠ¡

è¯­æ³• : 

```mysql
START TRANSACTION|BEGIN[WORK]

COMMIT [WORK] [AND [NO] CHAIN] [[NO] RELEASE]

ROLLBACK [WORK] [AND [NO] CHAIN] [[NO] RELEASE]

SET AUTOCOMMIT = {0/1}

-- START TRANSACTION æˆ– BEGIN è¯­å¥å¯ä»¥å¼€å§‹ä¸€é¡¹æ–°çš„äº‹åŠ¡
-- COMMIT å’Œ ROLLBACK ç”¨æ¥æäº¤æˆ–è€…å›žæ»šäº‹åŠ¡
-- CHAIN å’Œ RELEASEå­å¥åˆ†åˆ«ç”¨æ¥å®šä¹‰åœ¨äº‹åŠ¡æäº¤æˆ–è€…å›žæ»šä¹‹åŽçš„æ“ä½œ,CHAINä¼šç«‹å³å¯åŠ¨ä¸€ä¸ªæ–°äº‹åŠ¡,å®¾ä¸”å’Œåˆšæ‰çš„äº‹åŠ¡å…·æœ‰ç›¸åŒçš„éš”ç¦»çº§åˆ«,RELEASEåˆ™ä¼šæ–­å¼€å’Œå®¢æˆ·ç«¯çš„è¿žæŽ¥
-- SET AUTOCOMMITå¯ä»¥ä¿®æ”¹å½“å‰è¿žæŽ¥çš„æäº¤æ–¹å¼,å¦‚æžœè®¾ç½®äº† SET AUTOCOMMIT=0,åˆ™è®¾ç½®ä¹‹åŽçš„æ‰€æœ‰äº‹åŠ¡éƒ½éœ€è¦é€šè¿‡æ˜Žç¡®çš„å‘½ä»¤è¿›è¡Œæäº¤æˆ–è€…å›žæ»š
```

å®žä¾‹

```mysql
mysql> DELIMITER $$
mysql> CREATE PROCEDURE p1(
    -> OUT p_return_code TINYINT
    -> )
    -> BEGIN
    -> 	 DECLARE EXIT HANDLER FOR SQLEXCEPTION
    -> 	 BEGIN  -- ERROR
    ->     SET p_return_code = 1;
    ->     ROLLBACK;  -- å›žæ»š
    ->   END;
    ->   DECLARE EXIT HANDLER FOR SQLWARNING
    ->   BEGIN  -- WARNING
    ->     SET p_return_code = 2;
    ->     ROLLBACK;  
    ->   END;
    ->   START TRANSACTION;  -- å¼€å§‹äº‹åŠ¡
    ->     DELETE FROM tb1;
    ->     INSERT INTO tb2(name) values('lyon');
    ->   COMMIT;
    ->   SET p_return_code = 0;  -- SUCCESS
    -> END $$
Query OK, 0 rows affected (0.10 sec)
-- è°ƒç”¨
SET @i = 0;
CALL p1(@i);
SELECT @i;
```